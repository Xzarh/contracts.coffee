<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>

  <title>disnet/contracts.coffee @ GitHub</title>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,400italic' rel='stylesheet' type='text/css'>

  <link href='documentation/contracts/styles/default.css' rel='stylesheet' type='text/css'>

  <style type="text/css">
    body {
      margin-top: 1.0em;
      background-color: white;
      font-family: 'Open Sans', sans-serif;
      font-size: 16pt;
      /* font-family: Helvetica, Arial, FreeSans, san-serif; */
      color: black;
    }

    #repl_container {
      display: none;
    }

    /* override the pygments error style for syntax highlighting */
    .err {
      border: 0 none;
    }

    code {
      background-color: #F0F3F3;
    }

    #repl_container.active {
      border-radius: 3px 3px 3px 3px;
      display: block;
      position: fixed;
      top: 50px;
      left: 200px;
      right: 40px;
      bottom: 200px;
      width: auto;
      height: auto;
      opacity: .95;
      background-color: lightgray;
      border: 1px solid black;
    }

    #repl_source_wrap, #repl_source {
      bottom: 15px;
      height: auto;
      left: 10px;
      margin-bottom: 0;
      position: absolute;
      right: 10px;
      top: 10px;
      width: auto;
    }

    #repl_source_wrap {
      float: left;
      right: 50%;
      padding: 4px;
      margin: 2px;
      width: 46%;
    }

    #repl_source {
      border: 0 none;
      height: 100%;
      width: 100%;
      font-size: 14px;
      resize: none;
      overflow-y: auto;
      background-color: lightgray;
      z-index: 1;
    }


    #repl_result_wrap, #repl_results {
      bottom: 15px;
      height: auto;
      left: 10px;
      margin-bottom: 0;
      position: absolute;
      right: 10px;
      top: 10px;
      width: auto;
    }

    #repl_result_wrap {
      white-space:pre;
      cursor: text;
      z-index: -1;
    /*
      float: left;
      padding: 4px;
      margin: 2px;
      height: 100%;
    */
    }

    #repl_results {
      left: 50%;
      height: auto;
      overflow-y: auto;
      font-size: 14px;
      background-color: lightgray;

      margin: 0;
      padding: 0;
      width: auto;
    }

    #run_button {
      border: 1px solid black;
      border-radius: 3px 3px 3px 3px;
      background-color: green;
      font-size: 14px;
      float: right;
      margin-top: 6px;
      margin-right: 6px;
      color: white;
      padding-left: 6px;
      padding-right: 6px;
      cursor: pointer;
      z-index: 1;
    }

    #blame {
      position: absolute;
      bottom: -170px;
      border-radius: 3px 3px 3px 3px;
      background: lightgray;
      border: 1px solid black;
      height: 150px;
      width: 100%;
    }

    #blame pre {
      background-color: lightgray;
      font-size: 14px;
      color: red;
    }

    #container {
      margin: 0 auto;
      width: 700px;
    }

    div.navigation {
      padding-top: 120px;
      position: fixed;
      font-size: 14pt;
    }

    .navigation li {
      list-style-type: none;
      text-decoration: underline;
      cursor: pointer;
    }

    pre {
      background-color: #F0F3F3;
      padding: 6px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    h1 { text-align: center; font-size: 3.8em; color: black; margin-bottom: 3px; }
    h1 .small { font-size: 0.4em; }
    h1 a { text-decoration: none }
    h2 { font-size: 1.5em; color: black; }
    h3 { text-align: center; color: black; }
    a { color: black; }
    .description { font-size: 1.2em; margin-bottom: 30px; margin-top: 30px; font-style: italic;}
    .download { float: right; }
    /* pre { background: #000; color: #fff; padding: 15px;} */
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    .footer { text-align:center; padding-top:30px; font-style: italic; }
  </style>
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-744645-1']);
    _gaq.push(['_trackPageview']);

    (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>
</head>

<body>
  <a href="http://github.com/disnet/contracts.coffee"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" /></a>


  <div class="navigation">
    <ul>
      <li><a href="#basics">Basics</a></li>
      <li><a href="#quickstart">Quick Start</a></li>
      <li><a href="#modules">Modules</a></li>
      <li><a href="#functions">Functions</a></li>
      <li><a href="#objects">Objects</a></li>
      <li><a href="#arrays">Arrays</a></li>
      <li><a href="#andor">And/Or</a></li>
      <li><a href="#naming">Naming</a></li>
      <li style="text-decoration: none;">&nbsp;</li>
      <li><span id="try_button">Try it now!</span></li>
    </ul>
  </div>

  <div id="repl_container">
    <div id="repl_editor">
      <div id="repl_source_wrap">
        <textarea id="repl_source"># Wrap the function in a contract that
# expects to be called with a number
# and will return a number as the result.

id :: (Num) -> Num
id = (x) -> x          

# Call "use" to initialize the contract.
# See the module section of the docs
# for more details about "use".

id = id.use()

# Violates the contract by calling id
# with a string instead of a number.

id "foo"          
</textarea>
      </div>
      <div id="repl_result_wrap">
        <pre id="repl_results"></pre>
      </div>
      <div id="run_button">Run</div>
      <div style="clear: both"></div>
    </div>
    <div id="blame"><pre></pre></div>
  </div>

  <div id="container">


    <h1><a href="http://github.com/disnet/contracts.coffee">contracts.coffee</a>
    </h1>

    <p>Contracts.coffee is a dialect of CoffeeScript with built-in support for contracts.</p>

<p>Contracts let you clearly&#8212;even beautifully&#8212;express how your code behaves, and free you from writing tons of boilerplate, defensive code.</p>

<p>You can think of contracts as <code>assert</code> on steroids.</p>
<span id='basics' />
<h2 id='basics'>Basics</h2>

<p>Here&#8217;s a simple example of a contract on a function:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>id</span> <span class='o'>::</span> <span class='nf'>(Num) -&gt;</span> <span class='nx'>Num</span>
<span class='nv'>id = </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span>
</code></pre>
</div>
<p>This says that the <code>id</code> function should always be called with a number and will always return a number. It looks a lot like types (in fact the syntax looks a <em>lot</em> like Haskell) but unlike types, contracts are enforced at runtime in pure JavaScript.</p>

<p>If we try to use <code>id</code> incorrectly:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>id</span> <span class='s2'>&quot;foo&quot;</span>
</code></pre>
</div>
<p>The program throws an error, which displays lots of nice information telling us what we did wrong:</p>
<pre style='color: red'>
Error: Contract violation: expected &lt;Number&gt;,
actual: "foo"
Value guarded in: id_module.js:42
  -- blame is on: client_code.js:104
Parent contracts:
(Number) -> Number 
</pre>
<p>You can also put contracts on objects.</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>person</span> <span class='o'>::</span>
    <span class='nv'>name: </span><span class='nx'>Str</span>
    <span class='nv'>age: </span><span class='nx'>Num</span>
<span class='nv'>person =</span>
    <span class='nv'>name: </span><span class='s2'>&quot;Bertrand Meyer&quot;</span>
    <span class='nv'>age: </span><span class='mi'>42</span>
</code></pre>
</div>
<p>And arrays.</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>loc</span> <span class='o'>::</span> <span class='p'>[...</span><span class='nx'>Num</span><span class='p'>]</span>
<span class='nv'>loc = </span><span class='p'>[</span><span class='mi'>99332</span><span class='p'>,</span> <span class='mi'>23452</span><span class='p'>,</span> <span class='mi'>123</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>5000</span><span class='p'>]</span>
</code></pre>
</div>
<p>And various combinations.</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>average</span> <span class='o'>::</span> <span class='nf'>({name: Str, age: Num}, [...Num]) -&gt;</span> <span class='nx'>Str</span>
<span class='nv'>average = </span><span class='nf'>(person, loc) -&gt;</span>
    <span class='nv'>sum = </span><span class='nx'>loc</span><span class='p'>.</span><span class='nx'>reduce</span> <span class='nf'>(s1, s2) -&gt;</span> <span class='nx'>s1</span> <span class='o'>+</span> <span class='nx'>s2</span>
    <span class='s2'>&quot;#{person.name} wrote on average </span>
<span class='s2'>     #{sum / loc.length} lines of code.&quot;</span>
</code></pre>
</div>
<p>Under the covers, contracts are really just normal functions that return <code>true</code> or <code>false</code>, so it&#8217;s really easy to roll your own.</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nv'>isEven = </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span> <span class='o'>%</span> <span class='mi'>2</span> <span class='o'>is</span> <span class='mi'>0</span>
<span class='nv'>isOdd = </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span> <span class='o'>%</span> <span class='mi'>2</span> <span class='o'>isnt</span> <span class='mi'>0</span>

<span class='nx'>addEvens</span> <span class='o'>::</span> <span class='nf'>(!isEven) -&gt;</span> <span class='o'>!</span><span class='nx'>isOdd</span>
<span class='nv'>addEvens = </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span> <span class='o'>+</span> <span class='mi'>1</span>
</code></pre>
</div>
<p>In fact, since contracts are checked at runtime, they can enforce properties that static type systems can only dream of.</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nv'>isPrime = </span><span class='nf'>(x) -&gt;</span> <span class='c1'># ...</span>

<span class='nx'>f</span> <span class='o'>::</span> <span class='nf'>(!isPrime) -&gt;</span> <span class='o'>!</span><span class='nx'>isPrime</span>
<span class='nv'>f = </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span>
</code></pre>
</div>
<p>Eat your heart out, Haskell :)</p>
<span id='quickstart' />
<h2 id='quick_start'>Quick Start</h2>

<p>Here&#8217;s what you need to actually start working with contracts.coffee.</p>

<p>First, grab the source from github.</p>
<div class='highlight'><pre><code class='bash'>git clone git://github.com/disnet/contracts.coffee.git
<span class='nb'>cd </span>contracts.coffee
git submodule init
git submodule update
</code></pre>
</div>
<p>Install <a href='https://github.com/joyent/node/wiki/Installation'>Node.js</a> and then contracts.coffee.</p>
<div class='highlight'><pre><code class='bash'>sudo bin/cake install
</code></pre>
</div>
<p>Now, compile some coffee with contracts!</p>
<div class='highlight'><pre><code class='bash'>coffee -cC MyContractedScript.coffee
</code></pre>
</div>
<p>Note the <code>-cC</code> flag. The <code>-c</code> says to compile to JavaScript and <code>-C</code> enables contracts in the compiled JavaScript. If you don&#8217;t want contracts enabled (say in production) simply don&#8217;t include the <code>-C</code> flag.</p>

<p>You will also need to include <code>loadContracts.js</code>, which is found in the root of contracts.coffee. So the header of your HTML file will look something like:</p>
<div class='highlight'><pre><code class='html'>...
<span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;loadContracts.js&quot;</span>
    <span class='na'>type=</span><span class='s'>&quot;application/javascript&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
<span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;MyContractedScript.js&quot;</span>
    <span class='na'>type=</span><span class='s'>&quot;application/javascript&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
...
</code></pre>
</div>
<p>Note that if you have an existing install of CoffeeScript, installing contracts.coffee will replace it. If you don&#8217;t want to give up the old CoffeeScript compiler you can just run contracts.coffee from its own directory:</p>
<div class='highlight'><pre><code class='bash'>bin/coffee -cC MyContractedScript.coffee
</code></pre>
</div>
<p>And finally, note that contracts.coffee requires some pretty new features of JavaScript to get its job done (in particular <a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Proxy'>Proxies</a>) so it currently only works on Firefox 4+. Support for other JavaScript engines is coming soon.</p>

<p>This means that if you attempt to run your contracted CoffeeScript under node/V8:</p>
<div class='highlight'><pre><code class='bash'><span class='c'># note the -c flag is missing</span>
coffee -C MyContractedScript.coffee
<span class='c'># Compile error!!!</span>
</code></pre>
</div>
<p>You will get a bunch of errors. So just compile to JavaScript and run it in Firefox for now.</p>
<span id='modules' />
<h2 id='a_word_on_modules'>A word on modules</h2>

<p>In order to provide good error messages when things go wrong, contracts.coffee attempts to enforce a kind of module separation in your code. What this means practically is that before you can use a value that has a contract on it, you must first <code>use()</code> it:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>id</span> <span class='o'>::</span> <span class='nf'>(Num) -&gt;</span> <span class='nx'>Num</span>
<span class='nv'>id = </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span>
<span class='nv'>id = </span><span class='nx'>id</span><span class='p'>.</span><span class='nx'>use</span><span class='p'>()</span>

<span class='nx'>id</span> <span class='mi'>4</span>     <span class='c1'># ok</span>
<span class='nx'>id</span> <span class='s2'>&quot;foo&quot;</span> <span class='c1'># Contract Violation...</span>
</code></pre>
</div>
<p>The <code>use()</code> function does the work of dynamically setting up the right names (for things like modules) that get used in error messages.</p>

<p>This is an unfortunate bit of syntax that we hope to do implicitly in the future with better compiler and module support.</p>

<p>To see what recording the right names with <code>use()</code> gives us, consider this example:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='lineno'>1</span> <span class='c1'># StringLibrary.coffee</span>
<span class='lineno'>2</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>concat</span> <span class='o'>::</span> <span class='nf'>(Str, Str) -&gt;</span> <span class='nx'>Str</span>
<span class='lineno'>3</span> <span class='nb'>window</span><span class='p'>.</span><span class='nv'>concat = </span><span class='nf'>(x, y) -&gt;</span> <span class='nx'>x</span> <span class='o'>+</span> <span class='nx'>y</span>
</code></pre>
</div><div class='highlight'><pre><code class='coffeescript'><span class='lineno'>1</span> <span class='c1'># Server.coffee</span>
<span class='lineno'>2</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>doStuff</span> <span class='o'>::</span> <span class='p'>(</span><span class='nf'>(Num, Num) -&gt;</span> <span class='nx'>Num</span><span class='p'>,</span> <span class='nx'>Num</span><span class='p'>)</span> <span class='o'>-&gt;</span> <span class='nx'>Num</span>
<span class='lineno'>3</span> <span class='nb'>window</span><span class='p'>.</span><span class='nv'>doStuff = </span><span class='nf'>(callback, n) -&gt;</span>
<span class='lineno'>4</span>   <span class='nx'>callback</span> <span class='mi'>42</span><span class='p'>,</span> <span class='nx'>n</span>   <span class='c1'># failure is here</span>
</code></pre>
</div><div class='highlight'><pre><code class='coffeescript'><span class='lineno'>1</span> <span class='c1'># Main.coffee</span>
<span class='lineno'>2</span> <span class='nv'>concat = </span><span class='nb'>window</span><span class='p'>.</span><span class='nx'>concat</span><span class='p'>.</span><span class='nx'>use</span><span class='p'>()</span>
<span class='lineno'>3</span> <span class='nv'>doStuff = </span><span class='nb'>window</span><span class='p'>.</span><span class='nx'>doStuff</span><span class='p'>.</span><span class='nx'>use</span><span class='p'>()</span>
<span class='lineno'>4</span> 
<span class='lineno'>5</span> <span class='c1'># concat takes Str but doStuff expects Num!</span>
<span class='lineno'>6</span> <span class='nx'>doStuff</span> <span class='nx'>concat</span><span class='p'>,</span> <span class='mi'>24</span>  
</code></pre>
</div>
<p>We get this contract violation:</p>
<pre style='color: red'>
Contract violation: expected &lt;String&gt;, actual: 42
Value guarded in: StringLibrary.js:2
  -- blame is on: Main.js:3
Parent contracts:
(String,String) -> String 
</pre>
<p>Here we have a library that provides some string manipulation functions and a server that expects to be given a callback that performs operations on numbers. The <code>Main</code> module <code>uses()</code> the string library and the server and then incorrectly calls the server with a string function.</p>

<p>Notice that the violation happens at <code>Server.coffee:4</code> when the callback is called with two numbers but the module at fault is actually <code>Main.coffee</code> (since it was responsible for providing <code>Server.coffee</code> with the correct callback). And, in fact, the error message gets this right!</p>

<p>It gets it right because <code>use()</code> records the module name where the contracted values were used and we correctly track all the module names through all the contract checks.</p>

<p>In general it is considered best practice to only put contracts on module boundaries but if you want to use them in the same module simply call <code>use()</code> immediately as shown above.</p>
<span id='functions' />
<h2 id='functions'>Functions</h2>

<p>Basic functions:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>f</span> <span class='o'>::</span> <span class='nf'>(Num) -&gt;</span> <span class='nx'>Num</span>
<span class='nv'>f = </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span>
</code></pre>
</div>
<p>Multiple arguments:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>f</span> <span class='o'>::</span> <span class='nf'>(Num, Str, Bool) -&gt;</span> <span class='nx'>Num</span>
<span class='nv'>f = </span><span class='nf'>(n, s, b) -&gt;</span> <span class='c1'># ...</span>
</code></pre>
</div>
<p>Optional arguments:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>f</span> <span class='o'>::</span> <span class='nf'>(Num, Str, Bool?) -&gt;</span> <span class='nx'>Num</span>
<span class='nv'>f = </span><span class='nf'>(n, s, b) -&gt;</span> <span class='c1'># ...</span>
</code></pre>
</div>
<p>All optional arguments must come at the end of the arguments list.</p>

<p>Higher order functions:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>f</span> <span class='o'>::</span> <span class='p'>(</span><span class='nf'>(Num) -&gt;</span> <span class='nx'>Bool</span><span class='p'>,</span> <span class='nx'>Num</span><span class='p'>)</span> <span class='o'>-&gt;</span> <span class='nx'>Bool</span>
<span class='nv'>f = </span><span class='nf'>(g, n) -&gt;</span> <span class='c1'># ...</span>
</code></pre>
</div>
<p>Functions that <em>cannot</em> be called with the <code>new</code> keyword:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>f</span> <span class='o'>::</span> <span class='p'>(</span><span class='nx'>Num</span><span class='p'>)</span> <span class='o'>--&gt;</span> <span class='nx'>Num</span>
<span class='nv'>f = </span><span class='nf'>(n) -&gt;</span> <span class='c1'># ...</span>
<span class='c1'>#...</span>

<span class='nv'>g = </span><span class='nx'>f</span> <span class='mi'>42</span>      <span class='c1'># ok</span>
<span class='nv'>g = </span><span class='k'>new</span> <span class='nx'>f</span> <span class='mi'>42</span>  <span class='c1'># error!</span>
</code></pre>
</div>
<p>Functions that can <em>only</em> be called with the <code>new</code> keyword:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>f</span> <span class='o'>::</span> <span class='p'>(</span><span class='nx'>Num</span><span class='p'>)</span> <span class='o'>==&gt;</span> <span class='nx'>Num</span>
<span class='nv'>f = </span><span class='nf'>(n) -&gt;</span> <span class='c1'># ...</span>
<span class='c1'>#...</span>

<span class='nv'>g = </span><span class='nx'>f</span> <span class='mi'>42</span>      <span class='c1'># error!</span>
<span class='nv'>g = </span><span class='k'>new</span> <span class='nx'>f</span> <span class='mi'>42</span>  <span class='c1'># ok</span>
</code></pre>
</div>
<p>Functions that get <code>new</code> inserted automatically if it was left out.</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>f</span> <span class='o'>::</span> <span class='p'>(</span><span class='nx'>Num</span><span class='p'>)</span> <span class='o'>-=&gt;</span> <span class='nx'>Num</span>
<span class='nv'>f = </span><span class='nf'>(n) -&gt;</span> <span class='c1'># ...</span>
<span class='c1'>#...</span>

<span class='nv'>g = </span><span class='nx'>f</span> <span class='mi'>42</span>      <span class='c1'># ok: converted to g = new f 42</span>
<span class='nv'>g = </span><span class='k'>new</span> <span class='nx'>f</span> <span class='mi'>42</span>  <span class='c1'># ok</span>
</code></pre>
</div>
<p>Dependent functions:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>inc</span> <span class='o'>::</span> <span class='nf'>(Num) -&gt;</span> <span class='o'>!</span><span class='nf'>(result) -&gt;</span> <span class='nx'>result</span> <span class='o'>&gt;</span> <span class='nx'>$1</span>
<span class='nv'>inc = </span><span class='nf'>(n) -&gt;</span> <span class='nx'>n</span> <span class='o'>+</span> <span class='mi'>1</span>
</code></pre>
</div>
<p>The variable <code>$1</code> is the first argument passed to the function (<code>$2</code> would be the second argument, <code>$3</code> the third, and so on). This allows us to compare the result of the function to its arguments. Note that the test is run after the function has completed so if any of the arguments were mutated during the function&#8217;s execution the test could give spurious results.</p>

<p>The <code>this</code> contract:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>f</span> <span class='o'>::</span> <span class='nf'>(Str, @{name: Str}) -&gt;</span> <span class='nx'>Str</span>
<span class='nv'>f = </span><span class='nf'>(s) -&gt;</span> <span class='c1'>#...</span>

<span class='nv'>o = </span><span class='p'>{</span> <span class='nv'>name: </span><span class='s2'>&quot;foo&quot;</span><span class='p'>,</span> <span class='nv'>f: </span><span class='nx'>f</span><span class='p'>}</span>
<span class='nx'>o</span><span class='p'>.</span><span class='nx'>f</span><span class='p'>()</span>
</code></pre>
</div>
<p>Checks that <code>this</code> matches the given object contract.</p>
<span id='objects' />
<h2 id='objects'>Objects</h2>

<p>Simple properties:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>o</span> <span class='o'>::</span>
  <span class='nv'>a: </span><span class='nx'>Str</span>
  <span class='nv'>b: </span><span class='nx'>Num</span>
  <span class='nv'>f: </span><span class='nf'>(Num) -&gt;</span> <span class='nx'>Num</span>
<span class='nv'>o =</span>
  <span class='nv'>a: </span><span class='s2'>&quot;foo&quot;</span>
  <span class='nv'>b: </span><span class='mi'>42</span>
  <span class='nv'>f: </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span>
</code></pre>
</div>
<p>Optional properties:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>o</span> <span class='o'>::</span>
  <span class='nv'>a: </span><span class='nx'>Str</span>
  <span class='nv'>b: </span><span class='nx'>Num</span><span class='o'>?</span>
  <span class='nv'>f: </span><span class='nf'>(Num) -&gt;</span> <span class='nx'>Num</span>
<span class='nv'>o =</span>
  <span class='nv'>a: </span><span class='s2'>&quot;foo&quot;</span>
  <span class='nv'>f: </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span>
</code></pre>
</div>
<p>Nested objects:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>o</span> <span class='o'>::</span>
  <span class='nv'>oo: </span><span class='p'>{</span> <span class='nv'>a: </span><span class='nx'>Str</span> <span class='p'>}</span>
  <span class='nv'>b: </span><span class='nx'>Num</span>
<span class='nv'>o =</span>
  <span class='nv'>oo: </span><span class='p'>{</span> <span class='nv'>a: </span><span class='s2'>&quot;foo&quot;</span> <span class='p'>}</span>
  <span class='nv'>b: </span><span class='mi'>42</span>
</code></pre>
</div>
<p>Recursive objects:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>o</span> <span class='o'>::</span>
  <span class='nv'>a: </span><span class='nx'>Num</span>
  <span class='nv'>b: </span><span class='nx'>Self</span>
  <span class='nv'>c: </span><span class='nf'>(Num) -&gt;</span> <span class='nx'>Self</span>
<span class='nv'>o = </span><span class='c1'>#...</span>
</code></pre>
</div>
<p>Objects with functions that have pre and post conditions:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>o</span> <span class='o'>::</span>
  <span class='nv'>a: </span><span class='nx'>Num</span>
  <span class='nv'>f: </span><span class='nf'>(Num) -&gt;</span> <span class='nx'>Num</span> <span class='o'>|</span>
      <span class='nv'>pre: </span><span class='nf'>(o) -&gt;</span> <span class='nx'>o</span><span class='p'>.</span><span class='nx'>a</span> <span class='o'>&gt;</span> <span class='mi'>10</span>
      <span class='nv'>post: </span><span class='nf'>(o) -&gt;</span> <span class='nx'>o</span><span class='p'>.</span><span class='nx'>a</span> <span class='o'>&gt;</span> <span class='mi'>20</span>
<span class='nv'>o =</span>
  <span class='nv'>a: </span><span class='mi'>12</span>
  <span class='nv'>f: </span><span class='nf'>(x) -&gt;</span> <span class='err'>@</span><span class='p'>.</span><span class='nv'>a = </span><span class='err'>@</span><span class='p'>.</span><span class='nx'>a</span> <span class='o'>+</span> <span class='nx'>x</span>
</code></pre>
</div>
<p>The pre and post condition functions are called with the object that <code>f</code> is a member of. As their names imply, <code>pre</code> is called before the function <code>f</code> is invoked and <code>post</code> is called after.</p>

<p>Object invariants:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>o</span> <span class='o'>::</span>
  <span class='nv'>a: </span><span class='nx'>Num</span>
  <span class='nv'>f: </span><span class='nf'>(Num) -&gt;</span> <span class='nx'>Num</span> <span class='o'>|</span>
      <span class='nv'>pre: </span><span class='nf'>(o) -&gt;</span> <span class='nx'>o</span><span class='p'>.</span><span class='nx'>a</span> <span class='o'>&gt;</span> <span class='mi'>10</span>
      <span class='nv'>post: </span><span class='nf'>(o) -&gt;</span> <span class='nx'>o</span><span class='p'>.</span><span class='nx'>a</span> <span class='o'>&gt;</span> <span class='mi'>20</span>
  <span class='o'>|</span> <span class='nv'>invariant: </span><span class='o'>-&gt;</span>
    <span class='err'>@</span><span class='p'>.</span><span class='nx'>a</span> <span class='o'>&gt;</span> <span class='mi'>0</span> <span class='o'>and</span> <span class='err'>@</span><span class='p'>.</span><span class='nx'>a</span> <span class='o'>&lt;</span> <span class='mi'>100</span>
<span class='nv'>o =</span>
  <span class='nv'>a: </span><span class='mi'>12</span>
  <span class='nv'>f: </span><span class='nf'>(x) -&gt;</span> <span class='err'>@</span><span class='p'>.</span><span class='nv'>a = </span><span class='err'>@</span><span class='p'>.</span><span class='nx'>a</span> <span class='o'>+</span> <span class='nx'>x</span>
</code></pre>
</div>
<p>The invariant is checked whenever there is a possibility of <code>o</code> mutating (on property sets, delete, etc.).</p>
<span id='arrays' />
<h2 id='arrays'>Arrays</h2>

<p>Basic arrays:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>a</span> <span class='o'>::</span> <span class='p'>[</span><span class='nx'>Num</span><span class='p'>,</span> <span class='nx'>Str</span><span class='p'>,</span> <span class='p'>[</span><span class='nx'>Bool</span><span class='p'>,</span> <span class='nx'>Num</span><span class='p'>]]</span>
<span class='nv'>a = </span><span class='p'>[</span><span class='mi'>42</span><span class='p'>,</span> <span class='s2'>&quot;foo&quot;</span><span class='p'>,</span> <span class='p'>[</span><span class='kc'>true</span><span class='p'>,</span> <span class='mi'>24</span><span class='p'>]</span>
</code></pre>
</div>
<p>This says the array must have three elements, the first being a <code>Num</code>, the second being a <code>Str</code>, and the third being another array.</p>

<p>Multiple elements:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>a</span> <span class='o'>::</span> <span class='p'>[...</span><span class='nx'>Num</span><span class='p'>]</span>
<span class='nv'>a = </span><span class='p'>[</span><span class='mi'>42</span><span class='p'>,</span> <span class='mi'>24</span><span class='p'>,</span> <span class='mi'>432</span><span class='p'>,</span> <span class='mi'>854</span><span class='p'>,</span> <span class='mi'>21</span><span class='p'>]</span>
</code></pre>
</div>
<p>The <code>...</code> operator says that the array will only contain <code>Num</code>s.</p>

<p>Mixing arrays</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>a</span> <span class='o'>::</span> <span class='p'>[</span><span class='nx'>Bool</span><span class='p'>,</span> <span class='nx'>Str</span><span class='p'>,</span> <span class='p'>...</span><span class='nx'>Num</span><span class='p'>]</span>
<span class='nv'>a = </span><span class='p'>[</span><span class='kc'>false</span><span class='p'>,</span> <span class='s2'>&quot;foo&quot;</span><span class='p'>,</span> <span class='mi'>432</span><span class='p'>,</span> <span class='mi'>854</span><span class='p'>,</span> <span class='mi'>21</span><span class='p'>]</span>
</code></pre>
</div>
<p>The <code>...</code> operator can be mixed with single contracts. This says that the array&#8217;s first and second positions must pass the first two contracts and the remaining array positions must pass <code>Num</code>. The <code>...</code> operator must be in the last position of the array contract.</p>
<span id='andor' />
<h2 id='andor'>And/Or</h2>

<p>The <code>or</code> contract:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>o</span> <span class='o'>::</span> <span class='p'>{</span> <span class='nv'>a: </span><span class='nx'>Num</span> <span class='o'>or</span> <span class='nx'>Str</span> <span class='p'>}</span>
<span class='nv'>o = </span><span class='p'>{</span> <span class='nv'>a: </span><span class='mi'>42</span> <span class='p'>}</span>
</code></pre>
</div>
<p>Here, the <code>a</code> property must pass either the <code>Num</code> or <code>Str</code> contract. Note that since contracts like function and object have deferred checking, they cannot be used with the <code>or</code> contract. Or to be more precise only <em>one</em> function/object contract can be used with <code>or</code>. So you could have <code>Num or (Num) -&gt; Num</code> but not <code>((Num) -&gt; Num) or ((Str) -&gt; Str)</code>. If you combine normal contracts and function/object contracts with <code>or</code> all the normal contracts will be checked first and then the function/object contract will be applied.</p>

<p>The <code>and</code> contract:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>o</span> <span class='o'>::</span> <span class='p'>{</span> <span class='nv'>a: </span><span class='nx'>Num</span> <span class='o'>and</span> <span class='nx'>Even</span> <span class='p'>}</span>
<span class='nv'>o = </span><span class='p'>{</span> <span class='nv'>a: </span><span class='mi'>42</span> <span class='p'>}</span>
</code></pre>
</div>
<p>The <code>a</code> property must pass both the <code>Num</code> and <code>Even</code> contracts. Just like <code>or</code> you cannot use multiple function/object with <code>and</code>.</p>
<span id='naming' />
<h2 id='naming_your_own_contracts'>Naming your own contracts</h2>

<p>You can bind a contract to a variable just like normal expressions:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nv'>NumId = </span><span class='o'>?</span><span class='nf'>(Num) -&gt;</span> <span class='nx'>Num</span>

<span class='nx'>f</span> <span class='o'>::</span> <span class='nx'>NumId</span>
<span class='nv'>f = </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span>
</code></pre>
</div>
<p>The <code>?</code> operator allows you to escape out of the normal expression language and into the contract language.</p>

<p>You can also escape from the contract language to the normal expression language:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nx'>takesEvens</span> <span class='o'>::</span> <span class='p'>(</span><span class='o'>!</span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span> <span class='o'>%</span> <span class='mi'>2</span> <span class='o'>is</span> <span class='mi'>0</span><span class='p'>)</span> <span class='o'>-&gt;</span> <span class='nx'>Num</span>
<span class='nv'>takesEvens = </span><span class='nf'>(x) -&gt;</span> <span class='nx'>x</span>
</code></pre>
</div>
<p>The result of the expression in the <code>!</code> escape must be a function that returns a boolean. It is converted to a contract that checks its value against the function.</p>

<p>The standard <code>Num</code> and <code>Str</code> contracts you have seen are implemented as:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nv'>Num = </span><span class='o'>?!</span><span class='nf'>(x) -&gt;</span> <span class='k'>typeof</span> <span class='nx'>x</span> <span class='o'>is</span> <span class='s1'>&#39;number&#39;</span>
<span class='nv'>Str = </span><span class='o'>?!</span><span class='nf'>(x) -&gt;</span> <span class='k'>typeof</span> <span class='nx'>x</span> <span class='o'>is</span> <span class='s1'>&#39;string&#39;</span>
</code></pre>
</div>
<p>The syntax may look a little strange at first, but it can be read as &#8220;assign to <code>Num</code> the contract generated from the function <code>(x) -&gt;
...</code></p>

<p>It could also be written:</p>
<div class='highlight'><pre><code class='coffeescript'><span class='nv'>Num = </span><span class='nf'>(x) -&gt;</span> <span class='k'>typeof</span> <span class='nx'>x</span> <span class='o'>is</span> <span class='s1'>&#39;number&#39;</span>
<span class='nv'>Str = </span><span class='nf'>(x) -&gt;</span> <span class='k'>typeof</span> <span class='nx'>x</span> <span class='o'>is</span> <span class='s1'>&#39;string&#39;</span>

<span class='nv'>f = </span><span class='nf'>(!Num) -&gt;</span> <span class='o'>!</span><span class='nx'>Str</span>
</code></pre>
</div>

    <div class="footer">
      get the source code on GitHub : <a href="http://github.com/disnet/contracts.coffee">disnet/contracts.coffee</a>
    </div>

  </div>

  
  <script type="text/coffeescript">
    compileSource = ->
      source = $('#repl_source').val()
      window.compiledJS = ''
      try
        window.compiledJS = CoffeeScript.compile source, { bare: on, contracts: on, contractPrefix: off}
        el = $('#repl_results')[0]
        if el.innerText
          el.innerText = window.compiledJS
        else
          $(el).text window.compiledJS
        $('#blame pre').text("")
      catch error
        $('#blame pre').text(error.message)

    closeMenu = ->
      $("#repl_container").removeClass "active"

    $("#try_button").click ->
      if $("#repl_container").hasClass('active')
        closeMenu()
      else
        closeMenu()
        $("#repl_container").addClass 'active'
      false

    # Eval the compiled js.
    evalJS = ->
      try
        eval window.compiledJS
      catch error
        $('#blame pre').text(error.message)

    # Listen for keypresses and recompile.
    $('#repl_source').keyup -> compileSource()

    $('#run_button').click evalJS

    # Dismiss console if Escape pressed or click falls outside console
    # Trigger Run button on Ctrl-Enter
    $(document.body)
      .keydown (e) ->
        closeMenu() if e.which == 27
        evalJS() if e.which == 13 and (e.metaKey or e.ctrlKey) # and $('.minibutton.run:visible').length
      .click (e) ->
        return false if $(e.target).closest("#repl_container").length > 0
        closeMenu()

    $(document).ready ->
      compileSource()

  </script>

  <script src="documentation/vendor/jquery-1.4.2.js"></script>
  <script src="extras/coffee-script.js"></script>
  <script src="loadContracts.js"></script>
</body>
</html>
